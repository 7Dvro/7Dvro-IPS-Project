import React, { useState, useEffect } from 'react';
import { generateSecurityReport, analyzeVulnerabilityLogFile } from '../services/geminiService';
import { Shield, Play, Loader, CheckCircle, AlertOctagon, Upload, FileText, Download, ShieldAlert, Activity, Wifi, Network, Smartphone, Printer, Laptop } from 'lucide-react';
import { useLanguage } from '../contexts/LanguageContext';
import { useDashboard } from '../contexts/DashboardContext';
import { useSession } from '../contexts/SessionContext';
import { useAuth } from '../contexts/AuthContext';
import { useTheme } from '../contexts/ThemeContext';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip as ChartTooltip, ResponsiveContainer, AreaChart, Area } from 'recharts';

interface TrafficPoint {
    time: string;
    rx: number;
    tx: number;
}

interface DiscoveredDevice {
    id: string;
    ip: string;
    mac: string;
    name: string;
    type: 'laptop' | 'smartphone' | 'printer' | 'router' | 'server';
    isSelf?: boolean;
    status: 'active' | 'inactive';
}

export const VulnerabilityScanner: React.FC = () => {
  const { t, language } = useLanguage();
  const { updateDashboardStats } = useDashboard();
  const { logAction, currentUser } = useAuth();
  const { currentTheme } = useTheme();
  
  // Use session context
  const { 
    vulnMode, setVulnMode,
    vulnTarget, setVulnTarget,
    vulnFileContent, setVulnFileContent,
    vulnReport, setVulnReport
  } = useSession();

  const [isScanning, setIsScanning] = useState(false);

  // Local Network Scanner State
  const [trafficData, setTrafficData] = useState<TrafficPoint[]>([]);
  const [discoveredDevices, setDiscoveredDevices] = useState<DiscoveredDevice[]>([]);

  // Simulation effect for Traffic Monitor
  useEffect(() => {
    if (vulnTarget !== 'Local Network') return;

    const interval = setInterval(() => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        
        // Use navigator connection to influence "traffic" simulation
        let baseSpeed = 50;
        // @ts-ignore
        if (navigator.connection && navigator.connection.downlink) {
            // @ts-ignore
             baseSpeed = navigator.connection.downlink * 20; 
        }

        setTrafficData(prev => {
            const newData = [
                ...prev,
                {
                    time: timeStr,
                    rx: Math.floor(Math.random() * baseSpeed) + 10,
                    tx: Math.floor(Math.random() * (baseSpeed / 2)) + 5
                }
            ];
            return newData.slice(-20); // Keep last 20 points
        });
    }, 1000);

    return () => clearInterval(interval);
  }, [vulnTarget]);

  // Simulation effect for Device Discovery
  useEffect(() => {
    if (vulnTarget !== 'Local Network') {
        setDiscoveredDevices([]);
        return;
    }

    // Simulate gradual discovery
    const devices: DiscoveredDevice[] = [
        { id: '1', ip: '192.168.1.1', mac: '00:1A:2B:3C:4D:5E', name: 'Gateway / Router', type: 'router', status: 'active' },
        { id: '2', ip: '192.168.1.5', mac: 'AA:BB:CC:DD:EE:FF', name: 'Host Machine (You)', type: 'laptop', isSelf: true, status: 'active' },
        { id: '3', ip: '192.168.1.12', mac: '12:34:56:78:90:AB', name: 'Smart_Phone_Wifi', type: 'smartphone', status: 'active' },
        { id: '4', ip: '192.168.1.20', mac: 'FE:DC:BA:98:76:54', name: 'Office_Printer', type: 'printer', status: 'active' },
        { id: '5', ip: '192.168.1.100', mac: '11:22:33:44:55:66', name: 'File_Server_NAS', type: 'server', status: 'inactive' },
    ];

    let count = 0;
    const interval = setInterval(() => {
        if (count < devices.length) {
            setDiscoveredDevices(prev => {
                // Check if already exists
                if (prev.find(d => d.id === devices[count].id)) return prev;
                return [...prev, devices[count]];
            });
            count++;
        } else {
            clearInterval(interval);
        }
    }, 1200);

    return () => clearInterval(interval);
  }, [vulnTarget]);

  // Authorization Check
  if (currentUser?.role === 'VIEWER') {
    return (
        <div className="h-[calc(100vh-8rem)] flex items-center justify-center">
            <div className="text-center theme-bg-card p-8 rounded-lg border theme-border max-w-md">
                <ShieldAlert size={48} className="text-red-500 mx-auto mb-4" />
                <h2 className="text-xl font-bold theme-text-main mb-2">{t('access_denied')}</h2>
                <p className="theme-text-muted">{t('access_denied_desc')}</p>
            </div>
        </div>
    );
  }

  const startScan = async () => {
    setIsScanning(true);
    setVulnReport(null);
    
    logAction('START_SCAN', `Started ${vulnMode} scan on target: ${vulnMode === 'SIMULATION' ? vulnTarget : 'Uploaded File'}`);

    // Simulate scan duration
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    let result;
    if (vulnMode === 'SIMULATION') {
       // Pass language to service
       result = await generateSecurityReport(vulnTarget, language);
    } else {
       if (!vulnFileContent) {
         setIsScanning(false);
         return;
       }
       result = await analyzeVulnerabilityLogFile(vulnFileContent, language);
    }

    // Update charts based on analysis
    updateDashboardStats(result);

    setVulnReport(result);
    setIsScanning(false);
    logAction('SCAN_COMPLETE', 'Vulnerability assessment completed successfully');
  };

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        if (event.target?.result) {
          setVulnFileContent(event.target.result as string);
          // Clear report when new file is uploaded
          setVulnReport(null);
          logAction('FILE_UPLOAD', `Uploaded file: ${file.name}`);
        }
      };
      reader.readAsText(file);
    }
  };

  const getDeviceIcon = (type: string) => {
      switch(type) {
          case 'router': return <Network size={18} className="text-purple-400" />;
          case 'laptop': return <Laptop size={18} className="text-blue-400" />;
          case 'smartphone': return <Smartphone size={18} className="text-green-400" />;
          case 'printer': return <Printer size={18} className="text-orange-400" />;
          default: return <Activity size={18} className="theme-text-muted" />;
      }
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div className="theme-bg-card p-6 rounded-lg border theme-border">
        <h2 className="text-2xl font-bold theme-text-main mb-6 flex items-center gap-2 no-print">
          <AlertOctagon className="text-orange-500" />
          {t('scanner_title')}
        </h2>

        {/* Mode Toggle */}
        <div className="flex gap-4 mb-6 theme-bg-input p-1 rounded-lg w-fit no-print border theme-border">
          <button
            onClick={() => { setVulnMode('SIMULATION'); setVulnReport(null); setVulnTarget('Hospital'); }}
            className={`px-4 py-2 rounded-md text-sm font-bold transition-colors ${vulnMode === 'SIMULATION' ? 'theme-btn-primary' : 'theme-text-muted hover:theme-text-main'}`}
          >
            {t('mode_simulated')}
          </button>
          <button
            onClick={() => { setVulnMode('FILE'); setVulnReport(null); }}
            className={`px-4 py-2 rounded-md text-sm font-bold transition-colors ${vulnMode === 'FILE' ? 'theme-btn-primary' : 'theme-text-muted hover:theme-text-main'}`}
          >
            {t('mode_file')}
          </button>
        </div>
        
        <div className="flex gap-4 items-end mb-8 no-print">
          <div className="flex-1">
            {vulnMode === 'SIMULATION' ? (
              <>
                <label className="block text-sm font-medium theme-text-muted mb-2">{t('target_infra')}</label>
                <select 
                  value={vulnTarget}
                  onChange={(e) => {
                      setVulnTarget(e.target.value);
                      if (e.target.value === 'Local Network') {
                          setVulnReport(null); // Clear previous reports
                      }
                  }}
                  className="w-full theme-bg-input border theme-border rounded-md p-3 theme-text-main theme-ring-focus outline-none"
                >
                  <option value="Hospital">{t('hospital_option')}</option>
                  <option value="Airport">{t('airport_option')}</option>
                  <option value="Bank">{t('bank_option')}</option>
                  <option value="Local Network">{t('local_network_option')}</option>
                </select>
              </>
            ) : (
              <>
                <label className="block text-sm font-medium theme-text-muted mb-2">{t('upload_label')}</label>
                <div className="relative">
                  <input 
                    type="file"
                    accept=".txt,.csv,.log,.json"
                    onChange={handleFileUpload}
                    className="w-full theme-bg-input border theme-border rounded-md p-3 theme-text-main theme-ring-focus outline-none file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-white/10 file:theme-text-main hover:file:bg-white/20"
                  />
                  {vulnFileContent && (
                    <div className="mt-2 text-xs text-green-400 flex items-center gap-1">
                      <CheckCircle size={12} />
                      File loaded in memory ({(vulnFileContent.length / 1024).toFixed(1)} KB)
                    </div>
                  )}
                </div>
              </>
            )}
          </div>
          
          {/* Only show Start Scan button if NOT Local Network */}
          {vulnTarget !== 'Local Network' && (
              <button 
                onClick={startScan}
                disabled={isScanning || (vulnMode === 'FILE' && !vulnFileContent)}
                className={`px-6 py-3 rounded-md font-bold flex items-center gap-2 transition-all ${
                  isScanning || (vulnMode === 'FILE' && !vulnFileContent)
                    ? 'bg-slate-600 cursor-not-allowed' 
                    : 'theme-btn-primary'
                }`}
              >
                {isScanning ? <Loader className="animate-spin" size={20} /> : vulnMode === 'SIMULATION' ? <Play size={20} /> : <Upload size={20} />}
                {isScanning 
                  ? (vulnMode === 'SIMULATION' ? t('scanning') : t('analyzing_file')) 
                  : (vulnMode === 'SIMULATION' ? t('start_scan') : t('analyze_file'))
                }
              </button>
          )}
        </div>

        {/* LOCAL NETWORK MONITOR UI */}
        {vulnTarget === 'Local Network' && vulnMode === 'SIMULATION' && (
             <div className="space-y-6 animate-fade-in">
                
                {/* Traffic Graph */}
                <div className="theme-bg-input rounded-lg border theme-border p-4 shadow-inner">
                    <h3 className="text-sm font-bold theme-text-main flex items-center gap-2 mb-4">
                        <Activity className="text-[var(--accent)]" size={16} />
                        {t('net_monitor')} 
                        <span className="text-xs theme-text-muted font-normal ml-2">({t('packet_rate')})</span>
                    </h3>
                    <div className="h-[200px] w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={trafficData}>
                                <defs>
                                    <linearGradient id="colorRx" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor={currentTheme.colors.accent} stopOpacity={0.3}/>
                                        <stop offset="95%" stopColor={currentTheme.colors.accent} stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke={currentTheme.colors.border} vertical={false} />
                                <XAxis dataKey="time" hide />
                                <YAxis stroke={currentTheme.colors.textMuted} fontSize={10} axisLine={false} tickLine={false} />
                                <ChartTooltip 
                                    contentStyle={{ backgroundColor: currentTheme.colors.bgCard, borderColor: currentTheme.colors.border }}
                                    itemStyle={{ color: currentTheme.colors.textMain }}
                                />
                                <Area type="monotone" dataKey="rx" stroke={currentTheme.colors.accent} fillOpacity={1} fill="url(#colorRx)" />
                                <Area type="monotone" dataKey="tx" stroke="#10b981" fillOpacity={0} />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* Device List */}
                <div className="theme-bg-input rounded-lg border theme-border overflow-hidden">
                    <div className="p-4 border-b theme-border flex justify-between items-center bg-black/10">
                         <h3 className="text-sm font-bold theme-text-main flex items-center gap-2">
                             <Wifi className="text-green-500" size={16} />
                             {t('device_discovery')}
                         </h3>
                         {discoveredDevices.length < 5 && (
                             <div className="flex items-center gap-2 text-xs theme-text-accent animate-pulse">
                                 <Loader size={12} className="animate-spin" />
                                 {t('scanning_network')}
                             </div>
                         )}
                    </div>
                    <table className="w-full text-left text-sm">
                        <thead className="bg-black/20 theme-text-muted text-xs uppercase">
                            <tr>
                                <th className="px-4 py-3">{t('device_name')}</th>
                                <th className="px-4 py-3">{t('ip_address')}</th>
                                <th className="px-4 py-3">{t('mac_address')}</th>
                                <th className="px-4 py-3">{t('status')}</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y theme-border">
                            {discoveredDevices.map(device => (
                                <tr key={device.id} className={`hover:bg-white/5 transition-colors ${device.isSelf ? 'bg-[var(--accent)]/10' : ''}`}>
                                    <td className="px-4 py-3 theme-text-main font-medium flex items-center gap-2">
                                        {getDeviceIcon(device.type)}
                                        {device.name}
                                        {device.isSelf && <span className="text-[10px] bg-[var(--accent)] text-white px-1 rounded ml-1">{t('this_device')}</span>}
                                        {device.type === 'router' && <span className="text-[10px] bg-purple-500 text-white px-1 rounded ml-1">{t('gateway')}</span>}
                                    </td>
                                    <td className="px-4 py-3 theme-text-muted font-mono text-xs">{device.ip}</td>
                                    <td className="px-4 py-3 theme-text-muted font-mono text-xs">{device.mac}</td>
                                    <td className="px-4 py-3">
                                        <span className={`flex items-center gap-1.5 text-xs font-bold ${device.status === 'active' ? 'text-green-400' : 'text-slate-500'}`}>
                                            <div className={`w-1.5 h-1.5 rounded-full ${device.status === 'active' ? 'bg-green-500' : 'bg-slate-500'}`}></div>
                                            {device.status === 'active' ? t('status_active') : 'Inactive'}
                                        </span>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
             </div>
        )}

        {/* Standard Vulnerability Report (Only if NOT Local Network) */}
        {vulnReport && vulnTarget !== 'Local Network' && (
          <div className="theme-bg-input rounded-lg border theme-border p-6 animate-fade-in mt-6">
            {/* Header visible ONLY in print */}
            <div className="hidden print:block mb-6 border-b border-black pb-4">
              <h1 className="text-2xl font-bold mb-2">{t('scanner_title')}</h1>
              <p className="text-sm text-gray-600">{new Date().toLocaleString()} - Target: {vulnTarget}</p>
            </div>

            <div className="flex justify-between items-start mb-4 border-b theme-border pb-4 no-print">
               <div>
                  <h3 className="text-lg font-bold theme-text-main flex items-center gap-2">
                    <Shield className="text-green-500" size={20} />
                    {t('report_generated')}
                  </h3>
                  <p className="text-sm theme-text-muted mt-1">{new Date().toLocaleString()}</p>
               </div>
               <div className="px-3 py-1 bg-red-500/20 text-red-400 text-xs font-bold rounded border border-red-500/30 no-print">
                 {t('critical_found')}
               </div>
            </div>
            
            <div className={`prose prose-sm max-w-none ${currentTheme.type === 'dark' ? 'prose-invert' : ''}`}>
              <div className="whitespace-pre-wrap theme-text-main">
                {vulnReport}
              </div>
            </div>
            
            <div className="mt-6 pt-4 border-t theme-border flex justify-end no-print">
               <button 
                 onClick={() => window.print()}
                 className="px-4 py-2 theme-btn-primary rounded text-sm font-bold flex items-center gap-2 transition-colors"
               >
                 <Download size={16} />
                 {t('download_report')}
               </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};